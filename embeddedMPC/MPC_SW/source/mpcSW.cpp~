#include"mpcSW.h"
#include <string.h>

void mpcSW(elem x[N_SYS], elem yref[P_SYS], elem xmin[N_SYS], elem xmax[N_SYS], elem umin[M_SYS], elem umax[M_SYS], elem Acal[N_SYS*N_QP][N_SYS], elem AcalOmgOcal[N_SYS][N_QP], elem H[N_QP *N_QP], elem Mx[N_SYS*N_QP*2+2*N_QP *N_QP], elem L_last[N_SYS+P_SYS], int iterPDIP, int iterLS, elem tol, elem u[N_SYS]){

	elem cx[6*N_QP];
    elem h[N_QP];
	elem x_star[N_SYS];
	elem u_star[M_SYS];
	elem a[N_QP];
	elem b[N_QP];
	elem x_tilde[N_SYS];
	elem u_tilde[N_QP];

	// MATLAB: [x_star,u_star] = Infinity(A,B,C,yref);
	for (int i=0; i<N_SYS; i++){
		x_star[i] = L_last[i]*yref[0];
	}
	for (int i=0; i<M_SYS; i++){
		u_star[i] = L_last[i+N_SYS]*yref[0];
	}
	
	// MATLAB: a=ones(N,1)*(umin-uinfy);
	for (int i=0; i<N_QP; i++){
		a[i] = umin[0] - u_star[0];
	}
	// MATLAB: b=ones(N,1)*(umax-uinfy);	
	for (int i=0; i<N_QP; i++){
		b[i] = umax[0] - u_star[0];
	}
	
	// MATLAB: x_tilde=x-x_star;
	for (int i=0; i<N_SYS; i++){
		x_tilde[i] = x[i] - x_star[i];
	}
	
	// MATLAB: h=(2*x_tilde'*Acal'*Omg*Ocal)';
	// AclaOmgOcal = Acal'*Omg*Ocal
    get_h(AcalOmgOcal, x_tilde, h);

	// MATLAB: c = [(Xmax-Acal*x_tilde);-(Xmin-Acal*x_tilde)];
	// MATLAB: cx = [c;b;a];
	get_cx(Acal, xmax, xmin, x_star, x_tilde, a, b, cx);

	// MATLAB: [u_tilde,~,~,~,saveMat]=pdip(H,h,Mx,cx,iterPDIP,1e-9,linSol,mrmax,saveMat);
    pdipSW(H, h, Mx, cx, u_tilde, iterPDIP, iterLS, tol, CHOL_SW);

	// MATLAB: u=u_tilde(1)+u_star;
	u[0]=u_tilde[0]+u_star[0];

	// CREACION Y ESCRITURA DE ARCHIVO .CSV
	// Nombre de archivo csv
	char dim[] = "4";
	char csv_name[25];
	char format_csv_name[] = "csv_pdipMPC%sx%s.csv";
	sprintf(csv_name, format_csv_name, dim, dim);
	// Creacion del archivo y escritura al final del archivo
	FILE *fp;
	fp = fopen(csv_name, "a");
	// Imprimir
	fprintf(fp, "%.9f,%.9f,%.9f\n", u_tilde[0], x[0], x[1] );
	// Cierre del archivo y termino
	fclose(fp);
	
}

void get_h(elem AcalQOcal[N_SYS][N_QP], elem x_tilde[N_SYS], elem h[N_QP]){
	for (int i=0; i<N_QP; i++){
        h[i] = 0;
		for (int j=0; j<N_SYS; j++){
            h[i] += 2*x_tilde[j]*AcalQOcal[j][i];
		}
	}
}
void get_cx(elem Acal[N_SYS*N_QP][N_SYS], elem xmax[N_SYS], elem xmin[N_SYS], elem x_star[N_SYS], elem x_tilde[N_SYS], elem a[N_QP], elem b[N_QP], elem cx[6*N_QP]){

	for (int i=0; i<2*N_QP; i++){
		cx[i] =   xmax[i%N_SYS]- x_star[i%N_SYS];
		for (int c=0; c<N_SYS; c++){
			cx[i] -= Acal[i%(N_SYS*N_QP)][c]*x_tilde[c];
		}
	}
	
	for (int i=0; i<2*N_QP; i++){
		cx[i+2*N_QP] =   - (xmin[i%N_SYS]- x_star[i%N_SYS]);
		for (int c=0; c<N_SYS; c++){
			cx[i+2*N_QP] += Acal[i%(N_SYS*N_QP)][c]*x_tilde[c];
		}
	}
	
	for (int i=0; i<N_QP; i++){
		cx[i+4*N_QP] = b[i];
	}
	
	for (int i=0; i<N_QP; i++){
		cx[i+5*N_QP] = -a[i];
	}
}
